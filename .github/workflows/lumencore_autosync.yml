name: LumenCore Autosync
on:
  schedule: [{ cron: "0 2 * * *" }]
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch KPIs and rebuild snapshot
        env: { VPS_IP: ${{ vars.VPS_IP }} }
        run: |
          set -e
          curl -fsS http://$VPS_IP:8080/api/public -o metrics.json || echo '{}' > metrics.json
          python3 - <<'PY'
import json, datetime, re
from pathlib import Path
k = json.load(open("metrics.json"))
snap = {
  "generated_at": datetime.datetime.utcnow().isoformat()+"Z",
  "github": k.get("github",{}),
  "packages": k.get("packages",{}),
  "telemetry": k.get("telemetry",{})
}
Path("adoption-snapshot.json").write_text(json.dumps(snap,indent=2))
# also refresh the date in README (keeps it fresh)
s = Path("README.md").read_text()
s = re.sub(r"\*\*Date:\*\*.*", f"**Date:** {datetime.date.today().isoformat()}", s)
Path("README.md").write_text(s)
PY
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add adoption-snapshot.json README.md || true
          git commit -m "data: nightly KPI autosync" || true
          git push

      - name: Publish nightly release (+ attach PDFs)
        env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: |
          set -e
          TAG="snapshot-$(date +%Y%m%d)"
          NAME="LumenCore KPI Snapshot $(date +%Y-%m-%d)"
          BODY="Automated nightly KPI sync and docs."
          # create release
          curl -fsS -X POST -H "Authorization: Bearer $GH_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/${{ github.repository }}/releases \
               -d "{\"tag_name\":\"$TAG\",\"name\":\"$NAME\",\"body\":\"$BODY\"}" > rel.json
          UPLOAD=$(jq -r .upload_url rel.json | sed 's/{?name,label}//')
          # attach any PDFs in /docs or repo root (if present)
          shopt -s globstar nullglob
          for f in **/*.pdf; do
            curl -fsS -X POST -H "Authorization: Bearer $GH_TOKEN" \
                 -H "Content-Type: application/pdf" \
                 --data-binary @"$f" "$UPLOAD?name=$(basename "$f")" || true
          done
